<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Order History</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <style>
    body {
      background-color: #f8f9fa;
    }
    .status-badge {
      font-size: 0.85rem;
      padding: 0.35em 0.65em;
      border-radius: 0.375rem;
    }
    .table-hover tbody tr:hover {
      background-color: #f1f1f1;
    }
    .card {
      border: none;
    }
  </style>
</head>
<body class="bg-light">

<div class="container mt-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h3>Your Order History</h3>
    <a href="supplier-list.html" class="btn btn-secondary">Back to Dashboard</a>
  </div>
  
  <div class="card shadow-sm">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0">
          <thead class="table-light">
            <tr>
              <th>Product</th>
              <th>Quantity</th>
              <th>Supplier</th>
              <th>Supplier Email</th>
              <th>Location</th>
              <th>Payment</th>
              <th>Status</th>
              <th>Order Date</th>
            </tr>
          </thead>
          <tbody id="orderList">
            <tr>
              <td colspan="8" class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 mb-0 text-muted">Loading your orders...</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore-compat.js"></script>

<script>
  // Initialize Firebase with your config
  const firebaseConfig = {
    apiKey: "AIzaSyAYHdIkhYD0az_6D6awMUTAb40WctEmGCY",
    authDomain: "street-sourcer.firebaseapp.com",
    projectId: "street-sourcer",
    storageBucket: "street-sourcer.appspot.com",
    messagingSenderId: "15894964108",
    appId: "1:15894964108:web:a97b17e9f6ef26552b18a9"
  };

  // Initialize Firebase and Firestore
  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  // Check authentication state
  auth.onAuthStateChanged((user) => {
    if (user) {
      console.log("User is signed in:", user.uid);
      fetchOrders(user.uid);
    } else {
      console.log("No user signed in - redirecting to login");
      window.location.href = "vendor-login.html";
    }
  });

  function fetchOrders(vendorId) {
    const orderList = document.getElementById('orderList');
    
    // Use Firestore query to get orders for the current user
    db.collection('orders')
      .where('vendorId', '==', vendorId)
      .orderBy('createdAt', 'desc') // Show newest orders first
      .onSnapshot(
        (querySnapshot) => {
          orderList.innerHTML = ''; // Clear loading message
          
          if (querySnapshot.empty) {
            orderList.innerHTML = `
              <tr>
                <td colspan="8" class="text-center py-5">
                  <h5 class="text-muted">No orders found</h5>
                  <p class="text-muted">You haven't placed any orders yet.</p>
                  <a href="supplier-list.html" class="btn btn-primary mt-2">Browse Products</a>
                </td>
              </tr>
            `;
            return;
          }
          
          querySnapshot.forEach(doc => {
            const order = doc.data();
            const row = document.createElement('tr');
            
            row.innerHTML = `
              <td>${order.product || '-'}</td>
              <td>${order.quantity ? order.quantity + ' kg' : '-'}</td>
              <td>${order.supplier || '-'}</td>
              <td>${order.supplierEmail || '-'}</td>
              <td>${order.location || '-'}</td>
              <td>${order.payment || '-'}</td>
              <td><span class="status-badge badge ${getStatusClass(order.status)}">${order.status || 'N/A'}</span></td>
              <td>${formatDate(order.createdAt)}</td>
            `;
            orderList.appendChild(row);
          });
        }, 
        (error) => {
          console.error("Error fetching orders:", error);
          orderList.innerHTML = `
            <tr>
              <td colspan="8" class="text-center py-5 text-danger">
                <h5>Error loading orders</h5>
                <p>Please try again later</p>
              </td>
            </tr>
          `;
        }
      );
  }

  function getStatusClass(status = "") {
    switch(status.toLowerCase()) {
      case 'pending': return 'bg-warning text-dark';
      case 'completed': return 'bg-success';
      case 'cancelled': return 'bg-danger';
      case 'shipped': return 'bg-info text-dark';
      default: return 'bg-secondary';
    }
  }

  function formatDate(timestamp) {
    // Firestore Timestamps need to be converted to a Date object
    if (timestamp && typeof timestamp.toDate === 'function') {
      const date = timestamp.toDate();
      return date.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
      });
    }
    return 'Invalid Date'; // Fallback for missing or invalid timestamp
  }
</script>

</body>
</html>