<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Supplier Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body { background-color: #f8f9fa; }
    .hover-effect { transition: all 0.3s ease; }
    .hover-effect:hover { color: #ffc107 !important; text-decoration: underline; }
    .navbar-brand { font-size: 1.4rem; }
    .status-badge { font-size: 0.85rem; padding: 0.35em 0.65em; }
    .table-hover tbody tr:hover { background-color: #f1f1f1; }
  </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
  <div class="container-fluid">
    <a class="navbar-brand fw-bold text-warning" href="#">ðŸŒ¾ Supplier Panel</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupplier">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse justify-content-end" id="navbarSupplier">
      <ul class="navbar-nav mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link text-white fw-semibold hover-effect" href="#">Profile</a></li>
        <li class="nav-item"><a class="nav-link text-white fw-semibold hover-effect" href="addproducts.html">Add Products</a></li>
        <li class="nav-item"><a class="nav-link text-danger fw-semibold hover-effect" id="logoutBtn" href="supplier-login.html">Logout</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container mt-4">
  <h4 id="productInventory">Your Product Inventory</h4>
  <div class="table-responsive">
    <table class="table table-bordered table-hover">
      <thead class="table-light">
        <tr>
          <th>Name</th>
          <th>Price (per kg)</th>
          <th>Stock Qty</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="inventoryTable">
        </tbody>
    </table>
  </div>

  <h4 id="orderRequests" class="mt-5">Incoming Order Requests</h4>
  <div class="table-responsive">
    <table class="table table-striped table-hover">
      <thead class="table-light">
        <tr>
          <th>Product</th>
          <th>Quantity</th>
          <th>Vendor Email</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="orderRequestsTable">
        </tbody>
    </table>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.1/firebase-auth-compat.js"></script>

<script>
  // Your Firebase configuration object
  const firebaseConfig = {
    apiKey: "AIzaSyAYHdIkhYD0az_6D6awMUTAb40WctEmGCY",
    authDomain: "street-sourcer.firebaseapp.com",
    projectId: "street-sourcer",
    storageBucket: "street-sourcer.appspot.com",
    messagingSenderId: "15894964108",
    appId: "1:15894964108:web:a97b17e9f6ef26552b18a9"
  };

  // Initialize Firebase
  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();
  
  // Check user authentication state
  auth.onAuthStateChanged((user) => {
    if (user) {
      // If logged in, fetch data
      fetchSupplierOrders(user.email);
      fetchSupplierInventory(user.uid);
    } else {
      // If not logged in, redirect to login page
      window.location.href = "supplier-login.html";
    }
  });

  // Function to fetch and display the supplier's product inventory
  function fetchSupplierInventory(supplierId) {
    const inventoryTable = document.getElementById("inventoryTable");
    db.collection("products").where("supplierId", "==", supplierId)
      .onSnapshot((snapshot) => {
        inventoryTable.innerHTML = "";
        if (snapshot.empty) {
          inventoryTable.innerHTML = `<tr><td colspan="4" class="text-center text-muted">You have not added any products yet.</td></tr>`;
          return;
        }
        snapshot.forEach(doc => {
          const product = doc.data();
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${product.name}</td>
            <td>â‚¹${product.price}</td>
            <td>${product.stock} kg</td>
            <td><button class="btn btn-sm btn-danger" onclick="deleteProduct('${doc.id}')">Delete</button></td>
          `;
          inventoryTable.appendChild(row);
        });
      });
  }

  // Function to delete a product from inventory
  function deleteProduct(productId) {
    if (confirm("Are you sure you want to delete this product?")) {
      db.collection("products").doc(productId).delete()
        .then(() => alert("Product deleted successfully."))
        .catch((error) => console.error("Error removing product: ", error));
    }
  }

  // Function to fetch orders and display them with an editable status dropdown
  function fetchSupplierOrders(supplierEmail) {
    const orderRequestsTable = document.getElementById("orderRequestsTable");
    db.collection("orders").where("supplierEmail", "==", supplierEmail)
      .orderBy("createdAt", "desc")
      .onSnapshot((snapshot) => {
        orderRequestsTable.innerHTML = "";
        if (snapshot.empty) {
          orderRequestsTable.innerHTML = `<tr><td colspan="4" class="text-center text-muted">No order requests found.</td></tr>`;
          return;
        }
        snapshot.forEach(doc => {
          const order = doc.data();
          const row = document.createElement("tr");

          // Determine if the order is completed to disable the dropdown
          const isCompleted = order.status === 'Completed';
          
          // Create the status dropdown menu
          const statusDropdown = `
            <select 
              class="form-select form-select-sm" 
              onchange="updateOrderStatus('${doc.id}', this.value)"
              ${isCompleted ? 'disabled' : ''}
            >
              <option value="Pending" ${order.status === 'Pending' ? 'selected' : ''}>Pending</option>
              <option value="Completed" ${order.status === 'Completed' ? 'selected' : ''}>Completed</option>
            </select>
          `;

          // Populate the table row with order data and the new dropdown
          row.innerHTML = `
            <td>${order.product}</td>
            <td>${order.quantity} kg</td>
            <td>${order.vendorEmail}</td>
            <td>${statusDropdown}</td>
          `;
          orderRequestsTable.appendChild(row);
        });
      });
  }

  // Function to update the order status in Firestore
  function updateOrderStatus(orderId, newStatus) {
    const orderRef = db.collection("orders").doc(orderId);

    orderRef.update({
      status: newStatus
    })
    .then(() => {
      console.log("Order status updated successfully!");
    })
    .catch((error) => {
      console.error("Error updating order status: ", error);
      alert("There was an error updating the status. Please try again.");
    });
  }

  // Logout functionality
  document.getElementById("logoutBtn").addEventListener("click", (e) => {
    e.preventDefault();
    auth.signOut().then(() => {
      window.location.href = "index.html";
    });
  });
</script>

</body>
</html>